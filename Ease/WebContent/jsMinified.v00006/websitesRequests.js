function loadRequestedWebsites(){$.get("WebsiteRequest").done(function(e){printRequestedWebsites(e.substring(4,e.length))})}function printRequestedWebsites(e){var t=JSON.parse(e);t.forEach(function(e){var t=new WebsiteRequest(websitesRequestsRow,e.url,e.date,e.userName,e.userEmail,e.db_id);t.printOnDocument(),websitesRequests.push(t)})}var websitesRequestsRow,websitesRequests=[],editRequestUrlPopup,websitesSelected=[],editedUrls=[],EditRequestUrlPopup=function(e){var t=this;this.rootEl=e,this.parentHandler=this.rootEl.closest("#easePopupsHandler"),this.errorRowHandler=$(".errorHandler",this.rootEl),this.goBackButtonHandler=$("#goBack",this.rootEl),this.urlInput=$("#websiteUrl",this.rootEl),this.submitButton=$("#nextStep",this.rootEl),this.emailSenderRow=$("#emailsToSend",this.rootEl),this.backButton=$("#goBack",this.rootEl),this.selectedRequest=null;var s=0;this.urlInput.on("input",function(){null==t.urlInput.val()||""===t.urlInput.val()?t.submitButton.addClass("locked"):t.submitButton.removeClass("locked")}),this.open=function(e){0!=websitesSelected.length&&(s=0,t.successEmail=e,currentAdminPopup=t,t.goToNextStep(),t.submitButton.on("click",t.nextStep),t.backButton.on("click",t.goBack),t.submitButton.removeClass("locked"),t.parentHandler.addClass("myshow"),t.rootEl.addClass("show"))},this.nextStep=function(){var e=t.urlInput.val();t.selectedRequest.setUrl(e),s++,s<websitesSelected.length?t.goToNextStep():t.goToSubmit()},this.goBack=function(){0==s?t.close():(s--,t.goToNextStep())},this.goToNextStep=function(){t.selectedRequest=websitesSelected[s],t.urlInput.val(t.selectedRequest.url)},this.goToSubmit=function(){t.printEmails(),t.submitButton.text("Send emails"),t.submitButton.off("click",t.nextStep),t.submitButton.on("click",t.submit)},this.printEmails=function(){t.urlInput.parent().addClass("hidden"),t.emailSenderRow.removeClass("hidden"),websitesSelected.forEach(function(e){t.emailSenderRow.append("<div class='request'>"+e.url+" : "+e.userEmail)})},this.submit=function(){if(!t.submitButton.hasClass("locked")){var e=[];websitesSelected.forEach(function(t){var s={};s.url=t.url,s.db_id=t.db_id,s.user={email:t.userEmail,name:t.userName},e.push(s)});var s=JSON.stringify(e),i=t.successEmail?"SendWebsitesIntegrated":"SendFailToIntegrateWebsites";postHandler.post(i,{websiteRequests:s},function(){},function(){websitesSelected.forEach(function(e){e.removeFromDocument()}),t.close()},function(e){$("p",t.errorRowHandler).text(e)})}},this.reset=function(){t.selectedRequest=null,t.urlInput.val(""),t.submitButton.addClass("locked"),t.submitButton.off("click",t.nextStep),t.submitButton.off("click",t.submit)},this.close=function(){t.reset(),t.rootEl.removeClass("show"),t.parentHandler.removeClass("myshow")}},WebsiteRequest=function(e,t,s,i,o,n){var u=this;this.rootEl=e,this.url=t,this.date=s,this.userName=i,this.userEmail=o,this.db_id=n,this.elem=null,this.selected=!1,this.printOnDocument=function(){u.elem=$("<div class='requestedWebsite'><p><span class='quit'>x</span>"+u.url+" requested by "+u.userName+" ("+u.date+") - "+u.userEmail+"</p></div>").appendTo(u.rootEl),u.elem.on("click",".quit",u.remove),u.elem.on("click",u.select)},this.removeFromDocument=function(){u.elem.remove()},this.select=function(){if(u.elem.toggleClass("selected"),u.selected=!u.selected,u.selected)websitesSelected.push(u);else{var e=websitesSelected.indexOf(u);if(-1==e)return;websitesSelected.splice(e,1)}},this.remove=function(e){e.stopPropagation(),postHandler.post("EraseRequestedWebsite",{db_id:u.db_id},function(){},function(){var e=websitesSelected.indexOf(u);e>-1&&websitesSelected.splice(e,1),e=websitesRequests.indexOf(u),-1!=e&&(websitesRequests.splice(e,1),u.removeFromDocument())},function(){})},this.setUrl=function(e){u.url=e},this.doneEmail=function(e){e.preventDefault(),editRequestUrlPopup.open(u)},this.failEmail=function(e){e.preventDefault();var t="",s="";window.location="mailto:"+u.userEmail+"?subject="+t+"&body="+s}};$(document).ready(function(){websitesRequestsRow=$(".requestedWebsitesView .requests"),loadRequestedWebsites(),editRequestUrlPopup=new EditRequestUrlPopup($("#editRequestedWebsitePopup")),$("#done").click(function(){editRequestUrlPopup.open(!0)}),$("#fail").click(function(){editRequestUrlPopup.open(!1)})});